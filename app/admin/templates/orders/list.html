{% extends "base.html" %}

{% block title %}Orders - Admin Dashboard{% endblock %}

{% block extra_css %}
<style>
    /* Action button hover effects */
    .action-btn {
        transition: all 0.2s ease;
    }

    .action-btn:hover {
        transform: translateY(-1px);
    }

    /* Table row hover effect */
    tbody tr {
        transition: all 0.2s ease;
    }

    tbody tr:hover {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    /* Modal styles */
    .modal {
        transition: opacity 0.25s ease;
    }

    .modal-container {
        transition: all 0.25s ease;
    }

    .modal.active .modal-container {
        transform: scale(1);
    }

    .modal-container {
        transform: scale(0.9);
    }

    /* Dropdown menu */
    .dropdown-menu {
        transition: all 0.2s ease;
        transform-origin: top right;
    }

    .dropdown-menu.hidden {
        transform: scale(0.95);
        opacity: 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="bg-white shadow rounded-lg">
    <div class="px-4 py-5 sm:px-6 flex justify-between items-center">
        <h1 class="text-2xl font-semibold text-gray-900">Orders</h1>

        <!-- Status Filter -->
        <div class="flex items-center space-x-4">
            <label for="status-filter" class="text-sm font-medium text-gray-700">Filter by Status:</label>
            <select id="status-filter" onchange="window.location.href='?status=' + this.value"
                class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                <option value="">All Orders</option>
                {% for status in statuses %}
                <option value="{{ status.name.lower() }}" {% if current_status == status.name.lower() %}selected{% endif %}>
                    {{ status.name.title() }}
                </option>
                {% endfor %}
            </select>
        </div>
    </div>

    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Order No
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Date
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Client
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Total Amount
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Amount Paid
                    </th>

                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Actions
                    </th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for order in orders %}
                <tr class="hover:bg-gray-50 transition-colors duration-150" data-order-id="{{ order.id }}">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div>
                            <a href="/admin/orders/{{ order.id }}" class="text-blue-600 font-medium hover:text-blue-800 hover:underline">
                                #{{ order.order_no }}
                            </a>
                        </div>
                        <div class="mt-1">
                            <span class="px-2 py-1 inline-flex text-xs leading-4 font-medium rounded-full
                                {% if order.status == 'pending' %}
                                    bg-yellow-100 text-yellow-800
                                {% elif order.status == 'processing' %}
                                    bg-blue-100 text-blue-800
                                {% elif order.status == 'delivering' %}
                                    bg-purple-100 text-purple-800
                                {% elif order.status == 'delivered' %}
                                    bg-green-100 text-green-800
                                {% elif order.status == 'cancelled' %}
                                    bg-red-100 text-red-800
                                {% endif %}">
                                {{ order.status.title() }}
                            </span>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <div>{{ order.created_at.strftime('%Y-%m-%d') }}</div>
                        <div class="text-xs text-gray-400">{{ order.created_at.strftime('%H:%M:%S') }}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div>
                            {% if order.user %}
                                <div class="text-sm font-medium text-gray-900">{{ order.user.username }}</div>
                                <div class="text-sm text-gray-500">
                                    {% if order.user.phone_number %}
                                        <a href="tel:{{ order.user.phone_number }}" class="text-blue-600 hover:text-blue-800 hover:underline flex items-center">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                                            </svg>
                                            {{ order.user.phone_number }}
                                        </a>
                                    {% else %}
                                        <a href="mailto:{{ order.user.email }}" class="text-blue-600 hover:text-blue-800 hover:underline flex items-center">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                            </svg>
                                            {{ order.user.email }}
                                        </a>
                                    {% endif %}
                                </div>
                            {% elif order.guest_data and order.guest_data.name %}
                                <div class="text-sm font-medium text-gray-900">{{ order.guest_data.name }} (Guest)</div>
                                <div class="text-sm text-gray-500">
                                    {% if order.guest_data.phone %}
                                        <a href="tel:{{ order.guest_data.phone }}" class="text-blue-600 hover:text-blue-800 hover:underline flex items-center">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                                            </svg>
                                            {{ order.guest_data.phone }}
                                        </a>
                                    {% elif order.guest_email %}
                                        <a href="mailto:{{ order.guest_email }}" class="text-blue-600 hover:text-blue-800 hover:underline flex items-center">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                            </svg>
                                            {{ order.guest_email }}
                                        </a>
                                    {% endif %}
                                </div>
                            {% else %}
                                <div class="text-sm font-medium text-gray-900">Guest</div>
                                {% if order.guest_email %}
                                    <div class="text-sm text-gray-500">
                                        <a href="mailto:{{ order.guest_email }}" class="text-blue-600 hover:text-blue-800 hover:underline flex items-center">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                            </svg>
                                            {{ order.guest_email }}
                                        </a>
                                    </div>
                                {% endif %}
                            {% endif %}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ order.formatted_total_amount }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-500">
                            {{ order.formatted_amount_paid }}
                            {% if order.payment_status == 'partial_paid' %}
                            <span class="text-xs text-gray-500">({{ order.payment_percentage }}%)</span>
                            {% endif %}
                        </div>
                        <div class="mt-1">
                            <span class="px-2 py-1 inline-flex text-xs leading-4 font-medium rounded-full
                                {% if order.payment_status == 'pending' %}
                                    bg-yellow-100 text-yellow-800
                                {% elif order.payment_status == 'partial_paid' %}
                                    bg-blue-100 text-blue-800
                                {% elif order.payment_status == 'fully_paid' %}
                                    bg-green-100 text-green-800
                                {% elif order.payment_status == 'refunded' %}
                                    bg-gray-100 text-gray-800
                                {% endif %}">
                                {{ order.payment_status.replace('_', ' ').title() }}
                            </span>
                        </div>
                    </td>

                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex justify-center">
                            <div class="relative" x-data="{ open: false }">
                                <button @click="open = !open" class="text-gray-500 hover:text-gray-700 focus:outline-none dropdown-toggle p-2 rounded-full hover:bg-gray-100">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z" />
                                    </svg>
                                </button>

                                <div x-show="open"
                                     @click.away="open = false"
                                     class="dropdown-menu absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-10"
                                     x-transition:enter="transition ease-out duration-100"
                                     x-transition:enter-start="transform opacity-0 scale-95"
                                     x-transition:enter-end="transform opacity-100 scale-100"
                                     x-transition:leave="transition ease-in duration-75"
                                     x-transition:leave-start="transform opacity-100 scale-100"
                                     x-transition:leave-end="transform opacity-0 scale-95"
                                     style="display: none;">

                                    <a href="/admin/orders/{{ order.id }}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                        </svg>
                                        View Details
                                    </a>

                                    {% if order.status != 'cancelled' %}
                                    <button @click="open = false; document.getElementById('cancel-form-{{ order.id }}').submit();"
                                            class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                        Cancel Order
                                    </button>
                                    <form id="cancel-form-{{ order.id }}" action="/admin/orders/{{ order.id }}/cancel" method="post" class="hidden"></form>
                                    {% endif %}

                                    <button @click="open = false; showDeleteModal('{{ order.id }}', '{{ order.order_no }}');"
                                            class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                        </svg>
                                        Delete Order
                                    </button>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="px-6 py-4 bg-white border-t border-gray-200">
        <div class="text-sm text-gray-500">
            Showing 1 to {{ orders|length }} of {{ orders|length }} entries
        </div>
    </div>
</div>

<!-- Delete Order Modal -->
<div id="delete-modal" class="modal fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center hidden z-50">
    <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded shadow-lg overflow-y-auto">
        <div class="py-4 text-left px-6">
            <!-- Title -->
            <div class="flex justify-between items-center pb-3">
                <p class="text-xl font-bold text-red-600">Delete Order</p>
                <div class="cursor-pointer z-50" id="close-delete-modal">
                    <svg class="fill-current text-black" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18">
                        <path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"></path>
                    </svg>
                </div>
            </div>

            <!-- Order Details -->
            <div class="mb-4">
                <p class="text-sm text-gray-700">You are about to delete order <span id="delete-order-no" class="font-semibold"></span>. This action cannot be undone.</p>
                <p class="text-sm text-gray-700 mt-2">To confirm, please type the order number below:</p>

                <div class="mt-3">
                    <input type="text" id="confirm-order-no" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Enter order number">
                </div>

                <div id="delete-error" class="mt-2 text-sm text-red-600 hidden"></div>
            </div>

            <!-- Buttons -->
            <div class="flex justify-end pt-2">
                <button id="cancel-delete" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md mr-2 hover:bg-gray-300 focus:outline-none">
                    Cancel
                </button>
                <button id="confirm-delete" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 focus:outline-none opacity-50 cursor-not-allowed" disabled>
                    Delete Order
                </button>
                <input type="hidden" id="delete-order-id">
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
<script>
    // Make sure Alpine.js is loaded
    document.addEventListener('DOMContentLoaded', () => {
        if (typeof Alpine === 'undefined') {
            console.error('Alpine.js is not loaded. Loading from CDN...');
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js';
            script.defer = true;
            document.head.appendChild(script);
        }
    });

    // Variables for the delete modal
    const deleteModal = document.getElementById('delete-modal');
    const closeDeleteModal = document.getElementById('close-delete-modal');
    const cancelDelete = document.getElementById('cancel-delete');
    const confirmDelete = document.getElementById('confirm-delete');
    const deleteOrderId = document.getElementById('delete-order-id');
    const deleteOrderNo = document.getElementById('delete-order-no');
    const confirmOrderNo = document.getElementById('confirm-order-no');
    const deleteError = document.getElementById('delete-error');

    // Function to show the delete modal
    function showDeleteModal(orderId, orderNo) {
        deleteOrderId.value = orderId;
        deleteOrderNo.textContent = orderNo;
        confirmOrderNo.value = '';
        deleteError.classList.add('hidden');

        // Reset delete button state
        confirmDelete.disabled = true;
        confirmDelete.classList.add('opacity-50', 'cursor-not-allowed');
        confirmDelete.textContent = 'Delete Order';

        // Show the modal
        deleteModal.classList.remove('hidden');

        // Focus the input field
        setTimeout(() => {
            confirmOrderNo.focus();
        }, 100);
    }

    // Function to hide the delete modal
    function hideDeleteModal() {
        deleteModal.classList.add('hidden');
    }

    // Event listeners for the delete modal
    closeDeleteModal.addEventListener('click', hideDeleteModal);
    cancelDelete.addEventListener('click', hideDeleteModal);

    // Event listener for the confirm order number input
    confirmOrderNo.addEventListener('input', function() {
        const orderNo = deleteOrderNo.textContent;
        const confirmText = confirmOrderNo.value;

        // Enable the delete button only if the order number matches
        if (confirmText === orderNo) {
            confirmDelete.disabled = false;
            confirmDelete.classList.remove('opacity-50', 'cursor-not-allowed');
            deleteError.classList.add('hidden');
        } else {
            confirmDelete.disabled = true;
            confirmDelete.classList.add('opacity-50', 'cursor-not-allowed');

            // Show error message only if user has typed something
            if (confirmText.length > 0) {
                deleteError.textContent = 'Order number does not match. Please try again.';
                deleteError.classList.remove('hidden');
            } else {
                deleteError.classList.add('hidden');
            }
        }
    });

    // Event listener for the confirm delete button
    confirmDelete.addEventListener('click', async function() {
        // Skip validation since the button is only enabled when the input is correct
        const orderId = deleteOrderId.value;
        const orderNo = deleteOrderNo.textContent;

        try {
            // Show loading state
            confirmDelete.disabled = true;
            confirmDelete.innerHTML = '<svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Deleting...';

            // Send delete request
            const response = await fetch(`/admin/orders/${orderId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'Failed to delete order');
            }

            // Success - remove the row from the table
            const row = document.querySelector(`tr[data-order-id="${orderId}"]`);
            if (row) {
                // Add a fade-out effect before removing
                row.style.transition = 'opacity 0.5s ease';
                row.style.opacity = '0';

                setTimeout(() => {
                    row.remove();

                    // Update the count in the footer
                    updateOrderCount();
                }, 500);
            }

            // Hide the modal
            hideDeleteModal();

            // Show success message
            showNotification('Order deleted successfully', 'success');
        } catch (error) {
            // Show error message
            deleteError.textContent = error.message || 'An error occurred while deleting the order';
            deleteError.classList.remove('hidden');

            // Reset button state
            confirmDelete.disabled = false;
            confirmDelete.textContent = 'Delete Order';
        }
    });

    // Function to show notification
    function showNotification(message, type = 'info') {
        // Check if toastr is available
        if (typeof toastr !== 'undefined') {
            toastr[type](message);
        } else {
            alert(message);
        }
    }

    // Function to update the order count in the footer
    function updateOrderCount() {
        const tableBody = document.querySelector('tbody');
        const rows = tableBody.querySelectorAll('tr:not(.hidden)');
        const countElement = document.querySelector('.px-6.py-4.bg-white.border-t.border-gray-200 .text-sm.text-gray-500');

        if (countElement) {
            const count = rows.length;
            countElement.textContent = `Showing 1 to ${count} of ${count} entries`;
        }
    }

    // Fallback for dropdown menus if Alpine.js doesn't load
    document.addEventListener('DOMContentLoaded', () => {
        // Check if Alpine.js is loaded after a delay
        setTimeout(() => {
            if (typeof Alpine === 'undefined') {
                console.warn('Alpine.js not loaded, using fallback for dropdowns');

                // Get all dropdown buttons
                const dropdownButtons = document.querySelectorAll('.dropdown-toggle');

                // Add click event listeners to each button
                dropdownButtons.forEach(button => {
                    button.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();

                        // Find the dropdown menu
                        const dropdown = this.nextElementSibling;

                        // Toggle the display
                        if (dropdown.style.display === 'none' || dropdown.style.display === '') {
                            dropdown.style.display = 'block';
                        } else {
                            dropdown.style.display = 'none';
                        }
                    });
                });

                // Close dropdowns when clicking outside
                document.addEventListener('click', function(e) {
                    const dropdowns = document.querySelectorAll('.dropdown-menu');
                    dropdowns.forEach(dropdown => {
                        if (dropdown.style.display === 'block') {
                            dropdown.style.display = 'none';
                        }
                    });
                });
            }
        }, 1000); // Wait 1 second to check if Alpine.js is loaded
    });
</script>
{% endblock %}