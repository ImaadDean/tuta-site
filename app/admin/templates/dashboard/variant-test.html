<!DOCTYPE html>
<html>
<head>
    <title>Variant Test Page</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .grid-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .section {
            border: 1px solid #ddd;
            padding: 20px;
            border-radius: 8px;
        }
        .btn {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .btn-primary {
            background-color: #2196F3;
        }
        .btn-warning {
            background-color: #ff9800;
        }
        .btn-danger {
            background-color: #f44336;
        }
        input, select {
            padding: 8px;
            margin-bottom: 10px;
            width: 100%;
            box-sizing: border-box;
        }
        .product-item {
            border: 1px solid #eee;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        .variant-item {
            border: 1px solid #f0f0f0;
            padding: 8px;
            margin-bottom: 8px;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        pre {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .error {
            color: red;
            font-weight: bold;
        }
        .success {
            color: green;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Variant API Test</h1>
    
    <div class="grid-container">
        <div class="section">
            <h2>Products</h2>
            <button id="loadProductsBtn" class="btn">Load Products</button>
            <div id="productsList"></div>
        </div>
        
        <div class="section">
            <h2>Variant Test</h2>
            
            <input type="text" id="productIdInput" placeholder="Enter Product ID">
            <button id="loadVariantsBtn" class="btn btn-primary">Load Variants</button>
            <button id="debugProductBtn" class="btn btn-warning">Debug Product</button>
            
            <!-- Quick Test with problem ID -->
            <div style="margin-top: 10px; padding: 10px; background-color: #f8f8f8; border: 1px solid #ddd;">
                <h3>Quick Test</h3>
                <div>
                    <button id="testSpecificId" class="btn btn-danger">Test Product ID: 66848ab7-c7f8-4d29-8d84-a51ec089cd38</button>
                </div>
                <div style="margin-top: 5px;">
                    <button id="testWithRawFind" class="btn btn-danger">Test with MongoDB Raw Find</button>
                </div>
                <div style="margin-top: 5px;">
                    <button id="fixProduct" class="btn btn-danger">Fix Product Data</button>
                </div>
            </div>
            
            <div id="variantDetails">
                <h3>Variants</h3>
                <div id="variantsList"></div>
                
                <div id="discountForm" style="margin-top: 20px; display: none;">
                    <h3>Apply Discount</h3>
                    <select id="variantSelect">
                        <option value="">Select Variant</option>
                    </select>
                    <input type="number" id="oldPriceInput" placeholder="Old Price" readonly>
                    <input type="number" id="discountPriceInput" placeholder="Discount Price">
                    <button id="applyDiscountBtn" class="btn">Apply Discount</button>
                </div>
            </div>
            
            <div id="debugOutput" style="margin-top: 20px;">
                <h3>Debug Output</h3>
                <pre id="debugText"></pre>
            </div>
        </div>
    </div>
    
    <script>
        // Utility function to show debug info
        function debugLog(message, data = null) {
            const debugText = document.getElementById('debugText');
            let content = message;
            
            if (data) {
                if (typeof data === 'object') {
                    content += "\n" + JSON.stringify(data, null, 2);
                } else {
                    content += "\n" + data;
                }
            }
            
            debugText.textContent = content;
            console.log(message, data);
        }
        
        // Load products list
        document.getElementById('loadProductsBtn').addEventListener('click', async function() {
            const productsList = document.getElementById('productsList');
            productsList.innerHTML = '<p>Loading products...</p>';
            
            try {
                const response = await fetch('/api/admin/products');
                const data = await response.json();
                
                if (data.products && data.products.length > 0) {
                    let html = '';
                    
                    data.products.forEach(product => {
                        html += `
                            <div class="product-item">
                                <h3>${product.name}</h3>
                                <p>Price: ${product.price}</p>
                                <p>ID: ${product.id}</p>
                                <p>MongoDB ID: ${product._id || 'N/A'}</p>
                                <button class="btn btn-primary select-product" data-id="${product.id}" data-mongo-id="${product._id || ''}">Select</button>
                            </div>
                        `;
                    });
                    
                    productsList.innerHTML = html;
                    
                    // Add event listeners to select buttons
                    document.querySelectorAll('.select-product').forEach(button => {
                        button.addEventListener('click', function() {
                            const productId = this.getAttribute('data-id');
                            const mongoId = this.getAttribute('data-mongo-id');
                            document.getElementById('productIdInput').value = productId || mongoId;
                            debugLog(`Selected product: ${productId || mongoId}`);
                        });
                    });
                } else {
                    productsList.innerHTML = '<p>No products found</p>';
                }
            } catch (error) {
                productsList.innerHTML = `<p class="error">Error loading products: ${error.message}</p>`;
            }
        });
        
        // Debug product
        document.getElementById('debugProductBtn').addEventListener('click', async function() {
            const productId = document.getElementById('productIdInput').value.trim();
            
            if (!productId) {
                debugLog('Please enter a product ID');
                return;
            }
            
            debugLog(`Debugging product: ${productId}`, 'Fetching product details...');
            
            try {
                const response = await fetch(`/admin/products/${productId}/debug`);
                const data = await response.json();
                
                debugLog('Product debug response:', data);
                
                if (data.success && data.product) {
                    // Display variants if available
                    if (data.product.has_variants && data.product.variant_examples) {
                        let variantsList = document.getElementById('variantsList');
                        variantsList.innerHTML = '<h4>Example Variants:</h4>';
                        
                        for (const [variantType, variants] of Object.entries(data.product.variant_examples)) {
                            variantsList.innerHTML += `<p>Type: ${variantType}</p>`;
                            
                            variants.forEach(variant => {
                                variantsList.innerHTML += `
                                    <div class="variant-item">
                                        <p>ID: ${variant.id}</p>
                                        <p>Value: ${variant.value}</p>
                                        <p>Price: ${variant.price}</p>
                                        <p>Discount: ${variant.discount_percentage || 'None'}</p>
                                    </div>
                                `;
                            });
                        }
                    }
                } else if (!data.success) {
                    debugLog('Product not found', data.sample_products);
                }
            } catch (error) {
                debugLog(`Error debugging product: ${error.message}`);
            }
        });
        
        // Test Specific ID
        document.getElementById('testSpecificId').addEventListener('click', async function() {
            const productId = '66848ab7-c7f8-4d29-8d84-a51ec089cd38';
            document.getElementById('productIdInput').value = productId;
            
            debugLog(`Testing specific product ID: ${productId}`, 'Testing different methods...');
            
            // Try multiple methods to find the product
            try {
                // 1. Try debug endpoint
                debugLog('METHOD 1: Debug endpoint');
                const debugResponse = await fetch(`/admin/products/${productId}/debug`);
                const debugData = await debugResponse.json();
                debugLog('Debug endpoint result:', debugData);
                
                // 2. Try variants endpoint
                debugLog('METHOD 2: Variants endpoint');
                const variantResponse = await fetch(`/admin/products/${productId}/variants`);
                const variantData = await variantResponse.json();
                debugLog('Variants endpoint result:', variantData);
                
                // 3. Test with direct product view
                debugLog('METHOD 3: Product detail view');
                try {
                    const productResponse = await fetch(`/admin/products/${productId}`);
                    const productText = await productResponse.text();
                    debugLog('Product view response length:', productText.length);
                    debugLog('Product view status:', productResponse.status);
                } catch (err) {
                    debugLog('Product view error:', err.message);
                }
                
            } catch (error) {
                debugLog(`Error in multi-method test: ${error.message}`);
            }
        });
        
        // Test with MongoDB Raw Find
        document.getElementById('testWithRawFind').addEventListener('click', async function() {
            debugLog('Testing direct MongoDB find...');
            
            try {
                const response = await fetch('/admin/dashboard/api/debug/find?id=66848ab7-c7f8-4d29-8d84-a51ec089cd38');
                const data = await response.json();
                debugLog('Raw MongoDB find result:', data);
            } catch (error) {
                debugLog(`Error with raw find: ${error.message}`);
            }
        });
        
        // Fix Product Data
        document.getElementById('fixProduct').addEventListener('click', async function() {
            const productId = '66848ab7-c7f8-4d29-8d84-a51ec089cd38';
            debugLog(`Attempting to fix product with ID: ${productId}`);
            
            try {
                const response = await fetch(`/admin/dashboard/api/debug/fix-product?id=${productId}`);
                const data = await response.json();
                debugLog('Fix product result:', data);
                
                if (data.actions && data.actions.length > 0) {
                    let actionsHtml = '<div class="variant-item">';
                    actionsHtml += '<h4>Actions performed:</h4>';
                    actionsHtml += '<ul>';
                    
                    data.actions.forEach(action => {
                        actionsHtml += `<li>${action}</li>`;
                    });
                    
                    actionsHtml += '</ul>';
                    
                    if (data.fixed && data.fixed.variant_samples) {
                        actionsHtml += '<h4>Fixed variant samples:</h4>';
                        
                        for (const [type, variants] of Object.entries(data.fixed.variant_samples)) {
                            actionsHtml += `<p>Type: ${type}</p>`;
                            variants.forEach(variant => {
                                actionsHtml += `
                                    <div style="padding-left: 20px; margin-bottom: 5px;">
                                        <p>ID: ${variant.id}</p>
                                        <p>Value: ${variant.value}</p>
                                        <p>Price: ${variant.price}</p>
                                    </div>
                                `;
                            });
                        }
                    }
                    
                    actionsHtml += '</div>';
                    document.getElementById('variantsList').innerHTML = actionsHtml;
                }
                
                // Now try to load variants to confirm fix
                setTimeout(async () => {
                    debugLog('Testing variants after fix...');
                    try {
                        const variantResponse = await fetch(`/admin/products/${productId}/variants`);
                        const variantData = await variantResponse.json();
                        debugLog('Variants after fix:', variantData);
                    } catch (error) {
                        debugLog(`Error fetching variants after fix: ${error.message}`);
                    }
                }, 1000);
                
            } catch (error) {
                debugLog(`Error fixing product: ${error.message}`);
            }
        });
        
        // Load variants
        document.getElementById('loadVariantsBtn').addEventListener('click', async function() {
            const productId = document.getElementById('productIdInput').value.trim();
            
            if (!productId) {
                debugLog('Please enter a product ID');
                return;
            }
            
            const variantsList = document.getElementById('variantsList');
            const variantSelect = document.getElementById('variantSelect');
            
            variantsList.innerHTML = '<p>Loading variants...</p>';
            variantSelect.innerHTML = '<option value="">Select Variant</option>';
            
            try {
                debugLog(`Loading variants for product: ${productId}`, 'Fetching...');
                
                // First try the standard endpoint
                let response = await fetch(`/admin/products/${productId}/variants`);
                let data = await response.json();
                
                debugLog('Variants endpoint response:', data);
                
                // Initialize variants display
                let variants = [];
                
                if (data.success && data.variants && data.variants.length > 0) {
                    variants = data.variants;
                    debugLog(`Loaded ${variants.length} variants successfully`);
                } else {
                    // If standard endpoint fails, try debugging the product to get variants
                    debugLog('Standard variants endpoint failed, trying debug endpoint');
                    
                    const debugResponse = await fetch(`/admin/products/${productId}/debug`);
                    const debugData = await debugResponse.json();
                    
                    if (debugData.success && debugData.product && debugData.product.has_variants) {
                        // Flatten the variant examples into a single array
                        for (const [variantType, typeVariants] of Object.entries(debugData.product.variant_examples)) {
                            typeVariants.forEach(variant => {
                                variants.push({
                                    id: variant.id,
                                    type: variantType,
                                    value: variant.value,
                                    price: variant.price
                                });
                            });
                        }
                        debugLog(`Extracted ${variants.length} variants from debug endpoint`);
                    } else {
                        debugLog('No variants found through debug endpoint either');
                    }
                }
                
                // Display variants
                if (variants.length > 0) {
                    let html = '';
                    
                    variants.forEach(variant => {
                        html += `
                            <div class="variant-item">
                                <p>ID: ${variant.id}</p>
                                <p>Type: ${variant.type}</p>
                                <p>Value: ${variant.value}</p>
                                <p>Price: ${variant.price}</p>
                            </div>
                        `;
                        
                        // Add to select dropdown
                        variantSelect.innerHTML += `
                            <option value="${variant.id}" data-price="${variant.price}">
                                ${variant.type}: ${variant.value} - ${variant.price}
                            </option>
                        `;
                    });
                    
                    variantsList.innerHTML = html;
                    document.getElementById('discountForm').style.display = 'block';
                } else {
                    variantsList.innerHTML = '<p>No variants found for this product</p>';
                    document.getElementById('discountForm').style.display = 'none';
                }
            } catch (error) {
                variantsList.innerHTML = `<p class="error">Error loading variants: ${error.message}</p>`;
                debugLog(`Error loading variants: ${error.message}`);
            }
        });
        
        // Handle variant selection
        document.getElementById('variantSelect').addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const price = selectedOption.getAttribute('data-price');
            
            if (price) {
                document.getElementById('oldPriceInput').value = price;
            } else {
                document.getElementById('oldPriceInput').value = '';
            }
        });
        
        // Apply discount
        document.getElementById('applyDiscountBtn').addEventListener('click', async function() {
            const productId = document.getElementById('productIdInput').value.trim();
            const variantId = document.getElementById('variantSelect').value;
            const oldPrice = document.getElementById('oldPriceInput').value;
            const discountPrice = document.getElementById('discountPriceInput').value;
            
            if (!productId || !variantId) {
                debugLog('Please select a product and variant');
                return;
            }
            
            if (!oldPrice || !discountPrice) {
                debugLog('Please enter old and discount prices');
                return;
            }
            
            if (parseFloat(discountPrice) >= parseFloat(oldPrice)) {
                debugLog('Discount price must be less than the old price');
                return;
            }
            
            debugLog(`Applying discount for product ${productId}, variant ${variantId}`, {
                oldPrice,
                discountPrice
            });
            
            try {
                // Create form data
                const formData = new FormData();
                formData.append('old_price', oldPrice);
                formData.append('discount_price', discountPrice);
                
                // Show debug info about the form data
                debugLog('Sending form data:', {
                    old_price: oldPrice,
                    discount_price: discountPrice
                });
                
                const response = await fetch(`/admin/products/${productId}/variants/${variantId}/discount`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                debugLog('Discount response:', data);
                
                if (data.success) {
                    variantsList.innerHTML += `
                        <div class="variant-item success">
                            <p>Discount applied successfully!</p>
                            <p>${data.message}</p>
                        </div>
                    `;
                    
                    // Clear form
                    document.getElementById('discountPriceInput').value = '';
                } else {
                    debugLog('Error applying discount', data);
                }
            } catch (error) {
                debugLog(`Error applying discount: ${error.message}`);
            }
        });
    </script>
</body>
</html> 